<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Bing Maps integration with Tile Service Sample</title>
    <link href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.11/themes/redmond/jquery-ui.css"
        rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.5.2.min.js" type="text/javascript"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.11/jquery-ui.min.js" type="text/javascript"></script>
    <script type="text/javascript">

        // Bing Maps Ajax Version 7.0 control is used to display the tiles created using the WorldWide Telescope SDK in Bing Maps.
        // The tiles are served using the Tile Service Sample implementation in the SDK. The Bing imagery in the Bing Maps Ajax control is overwritten
        // with the pyramid tiles generated by the WorldWide Telescope SDK. 

        // The steps involve loading default Bing Maps tile layer by specifying the necessary options including the Bing Maps key,
        // creating a tile source by specifying the Tile Service URL and deploying the web page in the virtual directory.

        // Note that the Bing Maps key and the Web server name needs to be updated in the following code for the sample to work.
        // Also the query string parameters include the id of the tile pyramid that needs to be served through Bing Maps and the zoom level.
        // The id for the tile pyramid can be obtained from the Url attribute in the WTML file for the tile pyramid downloaded from the tile service.
        // The URL for this sample web page will look like http://localhost/Bing Maps integration with Tile Service Sample.html?Id=Alaska Glacier Bay&Zoom=5

        var isOpacityChanged = false;
        var map, tileSource, tilelayer;

        // Variables to read query string values. The sample takes the tile pyramid id and the zoom level as query string parameters. 
        var id, zoom;

        $(function () {
            // get query string as an array split on "&"
            var querystring = location.search.replace('?', '').split('&');
            // declare object
            var queryObj = {};
            // loop through each name-value pair and populate object
            for (var i = 0; i < querystring.length; i++) {
                // get name and value
                var name = querystring[i].split('=')[0];
                var value = querystring[i].split('=')[1];
                // populate object
                queryObj[name] = value;
            }

            // Query string parameters
            id = queryObj["Id"];
            zoom = queryObj["Zoom"];

            // This step loads the default Bing Maps tile layer, by specifying the road MapTypeId in the options passed to the constructor when 
            // the map is first initialized.
            map = new Microsoft.Maps.Map(document.getElementById("map"),
            { 
                // Put your Bing Maps key here
                credentials: "YOURBINGMAPKEY",
                zoom: parseInt(zoom),
                mapTypeId: Microsoft.Maps.MapTypeId.road
            });

            // The next step creates a new TileSource. The uriConstructor of the TileSource returns the correct URI for a requested tile. 
            // If the names used in the tile system match the default Bing Maps quadkey numbering system, then the uriConstructor can be a simple string 
            // using the {quadkey} placeholder. This is replaced with the appropriate quadkey when the tile is requested.
            // For tiles that do not follow the basic quadkey numbering system, a function is implemented to construct the appropriate URI for each tile: getTilePath. 
            // This is specified in the TileSource uriConstructor

            // Create the tile layer source
            tileSource = new Microsoft.Maps.TileSource({ uriConstructor: getTilePath });
            // Construct the layer using the tile source
            tilelayer = new Microsoft.Maps.TileLayer({ mercator: tileSource, opacity: 1 });
            // Push the tile layer to the map
            map.entities.push(tilelayer);

            //set up slider
            $('#opacitySlider').slider({
                value: 100,
                slide: function (event, ui) {
                    if (!isOpacityChanged) {
                        tilelayer.setOptions({ opacity: 100 });
                        isOpacityChanged = true;
                    }

                    $('.MicrosoftMap div div:eq(0) div:eq(1)').css({ opacity: (ui.value / 100) });
                },
                change: function (event, ui) {
                    tilelayer.setOptions({ opacity: (ui.value / 100) });
                    $('.MicrosoftMap div div:eq(0) div:eq(1)').css({ opacity: 100 });
                    isOpacityChanged = false;
                }
            });
        });

        function getTilePath(tileContext) {

            // The getTilePath function returns a string with the appropriate URI for the requested tile. For Tile service, 
            // a typical tile link looks like: http://YOURWEBSERVERNAME/SharingService/Service/TileService.svc/Resources/Tile?Id=pyramidid&level=levelvalue&x=xvalue&y=yvalue
            // The URL can be obtained from the Url attribute in the WTML file for the tile pyramid downloaded from the tile service.
            // To use tiles from other tile providers, replace the URI constructed by the getTilePath() function
            if (tileContext != null && tileContext != "undefined") {
                // Construct the uri path based on tile zoom level, x and y value
                // Put your Web server name here
                var path = "http://YOURWEBSERVERNAME/SharingService/Service/TileService.svc/Resources/Tile?Id=" + id + "&level=" + tileContext.levelOfDetail + "&x=" + tileContext.x + "&y=" + tileContext.y;
                return path;
            }
        }
    </script>
</head>
<body>
    <div id="map" style="position: relative; width: 1280px; height: 800px;">
    </div>
    <div id="opacitySlider" style="position: relative; width: 1280px;">
    </div>
</body>
</html>
